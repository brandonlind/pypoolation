[![](https://img.shields.io/badge/python-3.7-blue.svg?style=popout&logo=data:image/png;base64,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)](https://www.python.org)
[![](https://img.shields.io/badge/Developed%20With-PyCharm-yellow.svg?style=popout&logo=data:image/png;base64,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)](https://www.jetbrains.com/pycharm/)
[![Codacy Badge](https://api.codacy.com/project/badge/Grade/1d35004dc83c4bf492286e4f71a477a0)](https://app.codacy.com/manual/brandonlind/pypoolation?utm_source=github.com&utm_medium=referral&utm_content=brandonlind/pypoolation&utm_campaign=Badge_Grade_Dashboard)

# pypoolation
Using ipcluster engines to parallelize calculations from [varscan_pipeline](https://github.com/CoAdapTree/varscan_pipeline) outfiles, report Tajimas'D and/or Tajima's pi and/or Watterson's theta over user-defined windows (as in VarianceExactCorrection.pm from [popoolation](https://sourceforge.net/p/popoolation/code/HEAD/tree/trunk/Modules/VarianceExactCorrection.pm)). Alternatively, this code is likely to work relatively well with any txt files output by sending a VarScan vcf output to GATK's VariantsToTable.

## Assumed environment
This code was written and tested with python 3.7.6. It seemed that python3.8 had issues with parallelization implementation; this issue was not addressed in current version.

Module versions used can be mirrored with `pip install -r requirements.txt`

### example
The following is an example of environment setup and pypoolation execution (steps to `git clone` repo into `/data/programs`, and installing anaconda are not shown). If any errors are encountered when running pypoolation, make sure to execute `ipcluster stop` before re-running analysis. Creating an environment and installing requirements.txt only needs to be done once, afterwards activating the environment + exporting the PYTHONPATH is sufficient to run pypoolation.

```
# create new environment
conda create --name py37 python=3.7

# activate env
conda activate py37

# install reqs
cd /data/programs/pypoolation
pip install -r requirements.txt

# export pythonpath
export PYTHONPATH="${PYTHONPATH}:/data/programs/pypoolation"

# run pypoolation to calculate pi for pool named LPp19-2S_R1 using 20 CPUs
# (instantiation of INPUT, OUTDIR and PLOIDYFILE not shown)
python pypoolation.py -i INPUT \
-o OUTDIR \
-p PLOIDYFILE \
-e 20 \
-m pi \
--which-pops LPp19-2S_R1
```

## Usage
```
usage: pypoolation.py [-h] -i INPUT -o OUTDIR -m MEASURE -p PLOIDYFILE -e
                      ENGINES [--ipcluster-profile PROFILE]
                      [--which-pops WHICHPOPS [WHICHPOPS ...]]
                      [--min-count MINCOUNT] [--min-coverage MINCOV]
                      [--max-coverage MAXCOV]
                      [--min-coverage-fraction MINCOVFRACTION]
                      [--window-size WINDOWSIZE] [--chromfile CHROMFILE]


required arguments:
  -i INPUT, --input INPUT
                        /path/to/VariantsToTable_output.txt
                        It is assumed that there is either a 'CHROM' or 'unstitched_chrom'
                        column (ref.fa record name), and either a 'locus' or 'unstitched_locus' column.
                        The 'locus' column elements are the hyphen-separated
                        CHROM-POS. If the 'unstitched_chrom' column is present, the code will use the
                        'unstitched_locus' column for SNP names, otherwise 'CHROM' and 'locus'. The
                        'unstitched_locus' elements are therefore the hyphen-separated 
                        unstitched_locus-unstitched_pos. DP, AD, and RD columns from VarScan are also 
                        assumed.
  -o OUTDIR, --outdir OUTDIR
                        /path/to/pypoolation_output_dir/
  -m MEASURE, --measure MEASURE
                        pi OR theta OR D.
  -p PLOIDYFILE, --ploidy PLOIDYFILE
                        /path/to/the/ploidy.pkl file output by the VarScan pipeline. This is a python
                        dictionary with key=pool_name, value=dict with key=pop, value=ploidy. The code
                        will prompt for pool_name. pop(s) can be input with --whichpops.
  -e ENGINES, --engines ENGINES
                        The number of ipcluster engines that will be launched.


optional arguments:
  -h, --help            show this help message and exit
  --ipcluster-profile PROFILE
                        The ipcluster profile name with which to start engines. Default: 'default'
  --which-pops WHICHPOPS [WHICHPOPS ...]
                        Specific populations you would like statistics calculated - entered as a space separated list. Default=all
  --min-count MINCOUNT  The minimum count of the minor allele. Default=2
  --min-coverage MINCOV
                        The minimum coverage of a site. Sites with a lower coverage
                        will not be considered. Default=8
  --max-coverage MAXCOV
                        The maximum coverage of a site. Sites with greater values
                        will not be considered. Default=1000
  --min-coverage-fraction MINCOVFRACTION
                        The minimum fraction of a window having SNPs between min-coverage
                        and max-coverage (fraction = num snps / windowsize). Default=0.0
  --window-size WINDOWSIZE
                        The size of the sliding window. Windows are centered on
                        individual SNPs, so any SNP within 0.5*windowsize bps
                        from the current SNP will be included in the window. For the
                        CoAdapTree data, this strategy was most computationally
                        efficient. Data was further filtered after output. Default=1000bp
  --chromfile CHROMFILE
                        Path to .txt file with each line a chromosome/contig name
                        that is wished to be evaluated. All SNPs on this
                        chromosome/contig will be evaluated. It is assumed that
                        these chromosomes are in the "CHROM" or "unstitched_chrom"
                        column of the input file. If 'unstitched_chrom' column
                        is present in input file, then this is the default column
                        to use to parallelize input, otherwise CHROM is used.
                        Default to analyze=All.
```

